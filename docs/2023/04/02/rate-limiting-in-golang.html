<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gilda+Display&family=Inter&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">
    <link rel="stylesheet" href="/assets/css/index.css">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" as="style" onload="this.onload=null;this.rel='stylesheet'"/>
    <link rel="icon" href="/assets/img/favicon.ico">
    <link type="application/atom+xml" rel="alternate" href="https://kyungeun.kim/feed.xml" title="Kyungeun Kim" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Rate limiting in Golang using rate package | Kyungeun Kim</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Rate limiting in Golang using rate package" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Basic usage of rate package of Golang and explain how to use it to apply rate limiting in your application" />
<meta property="og:description" content="Basic usage of rate package of Golang and explain how to use it to apply rate limiting in your application" />
<link rel="canonical" href="https://kyungeun.kim/2023/04/02/rate-limiting-in-golang.html" />
<meta property="og:url" content="https://kyungeun.kim/2023/04/02/rate-limiting-in-golang.html" />
<meta property="og:site_name" content="Kyungeun Kim" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-02T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rate limiting in Golang using rate package" />
<meta name="twitter:site" content="@kyungeunni" />
<script type="application/ld+json">
{"description":"Basic usage of rate package of Golang and explain how to use it to apply rate limiting in your application","headline":"Rate limiting in Golang using rate package","dateModified":"2023-04-02T00:00:00+00:00","datePublished":"2023-04-02T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kyungeun.kim/2023/04/02/rate-limiting-in-golang.html"},"url":"https://kyungeun.kim/2023/04/02/rate-limiting-in-golang.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <div class="container">
      <nav class="nav">
    <div class="nav__menu">
        
            <a href="/" class="nav__item">
                Home
            </a>
        
            <a href="/posts" class="nav__item">
                Posts
            </a>
        
            <a href="/readings" class="nav__item">
                Readings
            </a>
        
    </div>
</nav>

      <div class="main">
        <div class="main__contents">
          <h1 class="post__title">Rate limiting in Golang using rate package</h1>

<p class="post__meta">
  
    02 Apr 2023
      - <a href="/" class="post__meta-author">Kyungeun Kim</a>
</p>

<div class="post__content">
<p>Rate Limiting comes up quite often when working with web servers. As a Golang newbie(and working on Backend after a while), I had a chance to implement the rate limiter on the client side to not overwhelm the target server while generating the load.</p>

<p>In this post, I’m going to talk about the <a href="https://pkg.go.dev/golang.org/x/time/rate">x/time/rate</a> package and how to use it as a batch processor working in intervals.</p>

<h2 id="how-limiter-works">How Limiter works</h2>
<p>To work with the package, we need to create a <a href="https://pkg.go.dev/golang.org/x/time/rate#Limiter">Limiter</a>. let’s briefly take a look at the definition:</p>
<blockquote>
  <p>A Limiter controls how frequently events are allowed to happen. It implements a “token bucket” of size b, initially full and refilled at the rate <code class="language-plaintext highlighter-rouge">r</code> tokens per second.</p>
</blockquote>

<p>This confused me quite a bit, so reading through the wiki about the <a href="https://en.wikipedia.org/wiki/Token_bucket">Token Bucket</a> algorithm helped me understand it better.</p>

<p>A simple analogy:
You have a bucket that can hold 10L(total number of tokens). It has a knob that you can turn and it will let the liquid flow so the bucket has more room as time goes on. For this particular bucket, I will let the liquid flow 1L per second(rate). When the bucket is empty, we can pour down 10L at once, or if there were 3L in the bucket already, we can only add 7L to the bucket(burst) at once. After 1 second since the bucket was full, you will have another room for 1L, or you wait for 0.5s to pour 0.5L (r tokens per second or 1 token per 1/r second).</p>

<p>Limiter is an implementation of the above and lets you control how frequently the events can happen.</p>

<h2 id="set-the-limit-and-burst">Set the Limit and Burst</h2>
<p>Two parameters are needed when creating a new Limiter: <code class="language-plaintext highlighter-rouge">rate</code> and <code class="language-plaintext highlighter-rouge">burst</code>. The first parameter <code class="language-plaintext highlighter-rouge">rate</code> is <code class="language-plaintext highlighter-rouge">Limit</code> type which defines the max frequency of some events. Passing 1 means 1 event per second is allowed for the limiter. There’s a handy function that helps you calculate the rate when you have an interval rather than 1 second; <code class="language-plaintext highlighter-rouge">rate.Every(t time.Duration)</code>. See examples below:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
    <span class="s">"time"</span>
	<span class="s">"golang.org/x/time/rate"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="n">rate</span><span class="o">.</span><span class="n">Every</span><span class="p">(</span><span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>  <span class="c">// 1 event per 5sec, r = 0.2</span>
    <span class="n">r</span> <span class="o">=</span> <span class="m">2</span> <span class="o">*</span> <span class="n">rate</span><span class="o">.</span><span class="n">Every</span><span class="p">(</span><span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span> <span class="c">// 2 events per 5sec, r = 0.4</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, you need to set the Burst size. Burst is the maximum number of tokens that can be consumed in a single call, in other words, n events can happen at once where n is the Burst size. So set this value that wouldn’t overwhelm the target server or protect your server from Ddos by setting the right burst size.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">r</span> <span class="o">:=</span> <span class="m">2</span> <span class="o">*</span> <span class="n">rate</span><span class="o">.</span><span class="n">Every</span><span class="p">(</span><span class="m">5</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="n">burst</span> <span class="o">:=</span> <span class="m">10</span>
	<span class="n">limiter</span> <span class="o">:=</span> <span class="n">rate</span><span class="o">.</span><span class="n">NewLimiter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">burst</span><span class="p">)</span> <span class="c">// Limiter allows 10 events to happen at once and refill 2 tokens every 5 seconds.</span>
</code></pre></div></div>
<p>Here’s a playground <a href="https://go.dev/play/p/esIE8YIlH3c">link</a> of the bucket example from the previous section in the code. Have a look, play with it, and assert your understanding.</p>

<h2 id="use-it-to-work-like-a-batch-processor-with-interval">Use it to work like a batch processor with Interval</h2>
<p>I had a task that required the limiter to send bursty events per interval while respecting the rate limit. As you can see from the above playground, I used <code class="language-plaintext highlighter-rouge">lim.Wait(ctx)</code> to wait for a token to be refiled so that I can send an event. This way, we can distribute the load evenly within a time duration, and it respects the event rate, so it kind of works. But for me, this wasn’t the case. I wanted to <em>send n events every t interval</em> without distributing the load. For this, you can use <code class="language-plaintext highlighter-rouge">lim.WaitN(ctx, n)</code>. This block until n tokens are refilled so that you can send n events at once. the <code class="language-plaintext highlighter-rouge">n</code> of course should be smaller than Burst size, otherwise, it returns an error.</p>

<p>Here’s an example. I want to send 100 events every 10 seconds. the rate r = 10/s. If you use Wait(ctx), it will let you send 1 request every 100ms. Instead, if you use <code class="language-plaintext highlighter-rouge">WaitN(ctx, 100)</code>, it takes 10 seconds to get the 100 tokens, so it will block for 10 seconds then you are allowed to send 100 events at once at the 10-second mark.</p>

<p><img src="/assets/img/2023-04-02-wait-waitn-comp.png" alt="Wait(ctx) vs WaitN(ctx, n)" width="780" /></p>

<h2 id="conclusion">Conclusion</h2>
<p>There are other strategies you could use when the events exceed the rate using Allow or Reserve method. The example above is the typical case where the events are enqueued when the available tokens are not enough. It’d be fun to apply different strategies to handle backpressure buildups or other cases of data flow possibilities.</p>

</div>

        </div>
      </div>
      <footer class="footer">
        <p class="footer__copyright">© 2022 Kyungeun Kim. All rights reserved.</p>
        <div class="footer__social">
            <a rel="github"
                href="https://github.com/kyungeunni"
                title="Kyungeun Kim Github">
                <i class="fab fa-github"></i>
            </a>
            <a rel="twitter"
                href="https://twitter.com/kyungeunni"
                title="Kyungeun Kim Twitter">
                <i class="fab fa-twitter"></i>
            </a>
            <a rel="linkedin"
                href="https://www.linkedin.com/in/kyungeun-kim-541021136"
                title="Kyungeun Kim Linkedin">
                <i class="fab fa-linkedin"></i>
            </a>
          </div>
      </footer>
    </div>
  </body>
</html>
